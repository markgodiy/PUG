# PUG Beginner/Intermediate Series - "Remote Sessions"

Topics Covered:
 1. Using VSCode as scripting environment
 2. Working with simple array variables
 3. Working with multiple hosts/servers
 4. Establishing remote shell sessions
 5. Copying files to remote hosts using sessions
 6. Enter sessions and execute command on remote hosts/servers


Commandlets:
 1. `Get-Content`
 2. `New-PSSession` (*Admin)
 3. `Copy-Item`
 4. `Enter-PSSession` (*Admin)
 5. `Invoke-Command` (*Admin)
 6. `Enable-PSRemoting`, or `winrm quickconfig`
* Admin credentials will be necessary to execute some commandlets

## VSCode
- Free MicroSoft product with lots of extensions
- Native support for PowerShell (.ps1) files, markdown files (.md), and a bunch of other programming/scripting languages
- Smart intellisense, etc.. 
- Version 1.x is DHA-approved, but must disable cloud services, automatic updates, 


## Arrays
Fundamental programming data structure for storing and organizing data

To identify variable type, you can use the built-in method `gettype()`, e.g., `$var.gettype()`

To count how many elements are in an array, use the built-in method `count()` or `length()`, e.g., `$var.count()`

### Creating a simple array 
```
$objs = "1","2","a","b"
```

### Initializing array variable

*INFO: In PowerShell, `$_` is the alias for the object being passed down the pipeline.*

Properly initialized array variable
```
$arr = @()
"1","2","a","b" | Foreach-object {$arr = $arr + $_}
$arr
#output: 1,2,a,b
$arr.count()
#count: 4
```
Otherwise  
```
"1","2","a","b" | Foreach-object {$arr = $arr + $_}
$arr 
#output: 12ab
$arr.count()
#Count: 1
```

### Dynamically, used in script: 

Example: List of hostnames in csv format: 

```
Hostname,IPAddress,MACAddress
atlantis,192.168.0.1,00:11:22:33:44:55
galaxy,192.168.0.2,AA:BB:CC:DD:EE:FF
firestorm,192.168.0.3,12:34:56:78:90:AB
mystique,192.168.0.4,CD:EF:01:23:45:67
phoenix,192.168.0.5,89:AB:CD:EF:01:23
serenity,192.168.0.6,F1:23:45:67:89:AB
nova,192.168.0.7,23:45:67:89:AB:CD
nebula,192.168.0.8,56:78:90:AB:CD:EF
lunaris,192.168.0.9,01:23:45:67:89:AB
orion,192.168.0.10,EF:01:23:45:67:89
```

*Tip: In PowerShell, `$arr += $_` is equivalent to `$arr = $arr + $_`*

```
$hostlist = Import-CSV "\\path\to\Hostnames.txt"

#Start Counter
$i = 0 

#Initialize array variable
$FinalOutput = @()

# Iterate through each hosts using foreach{} statement
foreach ($hostpc in $hostlist) {
  
  Write-Host "Processing $($hostpc.Hostname)"

  # Create a new custom object, then add to FinalOutput array
  $objHost = [pscustomobject]@{
    ID = $i
    Hostname = $hostpc.Hostname
    IPV4 = $hostpc.IPAddress
    MAC = $hostpc.MACAddress
    Ping = if(Test-Connection -ComputerName $hostpc.IPaddress -Count 1 -Quiet -ErrorAction 0) {"Online"} else {"Offline"}
    WinRMStatus = [bool](Test-WSman -ComputerName $hostpc.IPaddress -ea 0) 
  }

  # Add object to array
  $FinalOutput += $objHost

  # Increment counter
  $i++
}

#Output Array
$FinalOutput
```

## Remote PowerShell Sessions

### WSMan? WinRM? 

WS-Management (Web Services-Management, WSMan) is a Distributed Management Task Force (DMTF) open standard defining a SOAP-based protocol for the management of servers, devices, applications and various Web services. WS-Management provides a common way for systems to access and exchange management information across the IT infrastructure.

WinRM is the Microsoft implementation of WS-Management for Windows systems.

### Requirements: 

1. Administrator privileges

2. WinRM service must be running on remote host.

3. Firewall allows connections through ports 5986 (https) and 5985 (http)

### Testing if WinRM

### Initial configuration 

Hosts may need to be initialized for Windows Remote Management (WinRM). 

1. In admin command prompt: `winrm quickconfig`

2. In admin PowerShell session: `Enable-PSRemoting`
